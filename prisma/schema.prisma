// Prisma schema for CarSaller

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum MembershipRole {
  owner
  manager
  agent
}

enum ConversationStatus {
  open
  pending
  closed
}

enum VehicleStatus {
  draft
  published
  paused
  sold
}

model Tenant {
  id          String        @id @default(cuid())
  name        String
  slug        String        @unique
  description String?
  province    String
  city        String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  memberships Membership[]
  vehicles    Vehicle[]
  conversations Conversation[]
  invitations Invitation[]
  users       User[]
}

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  name         String?
  passwordHash String?
  tenantId     String?
  tenant       Tenant?       @relation(fields: [tenantId], references: [id])
  memberships  Membership[]
  vehicles     Vehicle[]     @relation("UserVehicles")
  conversations Conversation[] @relation("BuyerConversations")
  sellerConversations Conversation[] @relation("SellerConversations")
  assignedConversations Conversation[] @relation("AssignedConversations")
  messages     Message[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Membership {
  id        String         @id @default(cuid())
  role      MembershipRole
  tenantId  String
  tenant    Tenant         @relation(fields: [tenantId], references: [id])
  userId    String
  user      User           @relation(fields: [userId], references: [id])
  createdAt DateTime       @default(now())

  @@unique([tenantId, userId])
}

model Vehicle {
  id           String        @id @default(cuid())
  brand        String
  model        String
  year         Int
  trim         String?
  bodyType     String
  transmission String
  fuelType     String
  priceBase    Float
  currencyBase String
  mileage      Int
  color        String
  province     String
  city         String
  description  String
  photos       String[]
  status       VehicleStatus @default(draft)
  sellerId     String?
  seller       User?         @relation("UserVehicles", fields: [sellerId], references: [id])
  tenantId     String?
  tenant       Tenant?       @relation(fields: [tenantId], references: [id])
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  conversations Conversation[]

  @@index([brand])
  @@index([model])
  @@index([year])
  @@index([priceBase])
  @@index([province])
  @@index([status])
  @@index([tenantId])
  @@index([createdAt])
}

model Conversation {
  id           String             @id @default(cuid())
  vehicleId    String
  vehicle      Vehicle            @relation(fields: [vehicleId], references: [id])
  buyerId      String
  buyer        User               @relation("BuyerConversations", fields: [buyerId], references: [id])
  sellerId     String?
  seller       User?              @relation("SellerConversations", fields: [sellerId], references: [id])
  tenantId     String?
  tenant       Tenant?            @relation(fields: [tenantId], references: [id])
  assignedToUserId String?
  assignedToUser   User?          @relation("AssignedConversations", fields: [assignedToUserId], references: [id])
  status       ConversationStatus @default(open)
  createdAt    DateTime           @default(now())
  messages     Message[]

  @@index([tenantId])
  @@index([buyerId])
}

model Message {
  id             String       @id @default(cuid())
  content        String
  senderId       String
  sender         User         @relation(fields: [senderId], references: [id])
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  createdAt      DateTime     @default(now())
}

model ExchangeRate {
  id           String   @id @default(cuid())
  rateUsdToCrc Float
  source       String
  updatedAt    DateTime @default(now())
}

model Invitation {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  email       String
  role        MembershipRole
  token       String   @unique
  expiresAt   DateTime
  acceptedAt  DateTime?
  createdAt   DateTime @default(now())
}
